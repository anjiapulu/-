C51 COMPILER V9.54   MAIN                                                                  05/10/2021 21:37:16 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Program Files (x86)\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND T
                    -ABS(2)

line level    source

   1          /*********************************************************************************
   2          * дʱ䡿 20201212
   3          *     ߡ :03
   4          *      1.0
   5          *     վ http://www.QXMBOT.com/ 
   6          * Ա̡ http://qxmcu.taobao.com/ (ֱ)
   7          * ʵƽ̨ QX-A11ǿС  STC89C52
   8          * ⲿ񡿣 11.0592mhz 
   9          * оƬ STC89C52
  10          * 뻷 Keil Visio4
  11          * ȨУؾ
  12          * Copyright(C) QXMBOT
  13          * All rights reserved
  14          ***********************************************************************************
  15          * ˵οͼ˵
  16          * ܡQX-A11ǿСѭϺңһ                                  
  17          * עСײϰСӶת¹,P32ܽ豸
  18          **********************************************************************************/
  19          //ͨKEYлģʽĬѭģʽLED1,LED2״ָ̬ʾ𣬰һлģʽLDE1LED2
  20          //ٰһлңģʽLED2LED1
  21          //3׿Сڶ
  22          #include <REG52.H>//51ͷļ
  23          #include <QX_A11.h>//QX_A11Сļ
  24          unsigned char pwm_val_left,pwm_val_right; //мû޸ġ
  25          unsigned char   pwm_left,pwm_right;     //PWMߵƽʱıûPWMı
  26          unsigned char IRtime;     //ߵƽʱ䣨
  27          unsigned char IRcord[4];    //ڴ4ֽڵݣû2ֽ+ֵ2ֽڣ
  28          unsigned char IRdata[33];   //ڴ33λݣһλΪû16+ֵ16
  29          bit IRpro_ok, IRok;  //һں4ֽϡIRokΪ
  30          #define   PWM_DUTY    200     //PWMڣֵΪʱ0ڣ綨ʱʱΪ100usPWMΪ20m
             -s
  31          #define   PWM_HIGH_MIN  70      //PWMСռձȡû޸ġ
  32          #define   PWM_HIGH_MAX  PWM_DUTY  //PWMռձȡû޸ġ
  33          
  34          void Timer0_Init(void); //ʱ0ʼ
  35          void Timer1_Init(void); //ʱ1ʼ
  36          void EXTI0_Init(void);//ⲿж0ʼ
  37          void QXMBOT_LoadPWM(void);//װPWMֵ 
  38          void Delay_Ms(unsigned int ms);//뼶ʱ
  39          void forward(unsigned char LeftSpeed,unsigned char RightSpeed);//QX_A11Сǰ 
  40          void left_run(unsigned char LeftSpeed,unsigned char RightSpeed);//QX_A11Сת  
  41          void right_run(unsigned char LeftSpeed,unsigned char RightSpeed);//QX_A11Сת
  42          void back_run(unsigned char LeftSpeed,unsigned char RightSpeed);//QX_A11С
  43          void stop(void);//QX_A11Сͣ
  44          void Tracking(void);//ѭ
  45          void IRavoid(void);//
  46          void QXMBOT_IRcordpro(void);//
  47          void QXMBOT_IR_Remote(void);//ң
  48          
  49          /**/     
  50          void main(void)
  51          {
  52   1        unsigned char mode;
  53   1        EA_on;//ж
C51 COMPILER V9.54   MAIN                                                                  05/10/2021 21:37:16 PAGE 2   

  54   1        Timer0_Init();//ʱ0ʼ
  55   1        Timer1_Init();//ʱ1ʼ
  56   1        EXTI0_Init();//ⲿж0ʼ
  57   1        while(1)
  58   1        {
  59   2          if(KEY==0)//жKEYǷ
  60   2          {
  61   3            stop();//ͣ
  62   3            beep=0;//
  63   3            Delay_Ms(10); //
  64   3            if(KEY==0)//ٴжKEYǷ
  65   3            {
  66   4              mode++;
  67   4              while(!KEY);//ּ
  68   4              beep=1;//ر 
  69   4            }
  70   3          }
  71   2          if(mode > 2)  mode = 0;
  72   2          switch(mode)
  73   2          {
  74   3            case 0:  LED1=1,LED2=1; Tracking(); break; //ѭģʽ,LED1,LED2״ָ̬ʾϨ
  75   3            case 1:  LED1=0,LED2=1; IRavoid(); break;  //ģʽ,LED1,LED2
  76   3            case 2:  LED1=1,LED2=0; QXMBOT_IR_Remote(); break;//ңģʽ,LED1,LED2
  77   3            default: stop(); /*ͣ*/  break;
  78   3          }
  79   2        } 
  80   1      }
  81          
  82          
  83          /*********************************************
  84          QX_A11Сǰ
  85          ڲLeftSpeedRightSpeed
  86          ڲ: 
  87          ˵LeftSpeedRightSpeedֱҳת
  88          **********************************************/
  89          void forward(unsigned char LeftSpeed,unsigned char RightSpeed)
  90          {
  91   1        pwm_left = LeftSpeed,pwm_right =  RightSpeed;//ٶ
  92   1        left_motor_go; //ǰ
  93   1        right_motor_go; //ҵǰ
  94   1      }
  95          /*Сת*/
  96          /*********************************************
  97          QX_A11Сת
  98          ڲLeftSpeedRightSpeed
  99          ڲ: 
 100          ˵LeftSpeedRightSpeedֱҳת
 101          **********************************************/
 102          void left_run(unsigned char LeftSpeed,unsigned char RightSpeed)
 103          {
 104   1        pwm_left = LeftSpeed,pwm_right =  RightSpeed;//ٶ
 105   1        left_motor_back; //
 106   1        right_motor_go; //ҵǰ  
 107   1      }
 108          
 109          /*********************************************
 110          QX_A11Сת
 111          ڲLeftSpeedRightSpeed
 112          ڲ: 
 113          ˵LeftSpeedRightSpeedֱҳת
 114          **********************************************/
 115          void right_run(unsigned char LeftSpeed,unsigned char RightSpeed)
C51 COMPILER V9.54   MAIN                                                                  05/10/2021 21:37:16 PAGE 3   

 116          {
 117   1        pwm_left = LeftSpeed,pwm_right =  RightSpeed;//ٶ
 118   1        right_motor_back;//ҵ
 119   1        left_motor_go;    //ǰ
 120   1      }
 121          /*********************************************
 122          QX_A11С
 123          ڲLeftSpeedRightSpeed
 124          ڲ: 
 125          ˵LeftSpeedRightSpeedֱҳת
 126          **********************************************/
 127          void back_run(unsigned char LeftSpeed,unsigned char RightSpeed)
 128          {
 129   1        pwm_left = LeftSpeed,pwm_right =  RightSpeed;//ٶ
 130   1        right_motor_back;//ҵ
 131   1        left_motor_back; //
 132   1      }
 133          /*********************************************
 134          QX_A11Сͣ
 135          ڲ
 136          ڲ: 
 137          ˵QX_A11Сͣ
 138          **********************************************/
 139          void stop(void)
 140          {
 141   1        left_motor_stops;
 142   1        right_motor_stops;
 143   1      }
 144          /*********************************************
 145          QX_A11СPWM
 146          ڲ
 147          ڲ: 
 148          ˵װPWM,ȫֱpwm_left,pwm_rightֱߵƽʱ
 149          **********************************************/
 150          void QXMBOT_LoadPWM(void)
 151          {
 152   1        if(pwm_left > PWM_HIGH_MAX)   pwm_left = PWM_HIGH_MAX;  //дռձݣǿΪռ
             -ձȡ
 153   1        if(pwm_left < PWM_HIGH_MIN)   pwm_left = PWM_HIGH_MIN;  //дССռձݣǿΪСռ
             -ձȡ
 154   1        if(pwm_right > PWM_HIGH_MAX)  pwm_right = PWM_HIGH_MAX; //дռձݣǿΪռ
             -ձȡ
 155   1        if(pwm_right < PWM_HIGH_MIN)  pwm_right = PWM_HIGH_MIN; //дССռձݣǿΪСռ
             -ձȡ
 156   1        if(pwm_val_left<=pwm_left)    Left_moto_pwm = 1;  //װPWMߵƽʱ
 157   1        else Left_moto_pwm = 0;                 //װPWM͵ƽʱ
 158   1        if(pwm_val_left>=PWM_DUTY)    pwm_val_left = 0; //ԱֵڵռձݣΪ
 159   1      
 160   1        if(pwm_val_right<=pwm_right)  Right_moto_pwm = 1; //װPWMߵƽʱ
 161   1        else Right_moto_pwm = 0;              //װPWM͵ƽʱ
 162   1        if(pwm_val_right>=PWM_DUTY)   pwm_val_right = 0;  //ҶԱֵڵռձݣΪ
 163   1      }
 164          //ѭ
 165          void Tracking()
 166          {
 167   1        //Ϊ0 ûʶ𵽺 Ϊ1ʶ𵽺
 168   1        char data1,data2 = left_led1,data3 = right_led1;
 169   1        data1 = data2*10+data3;
 170   1        if(data1 == 11)//ںϣǰ
 171   1        {
 172   2          forward(120,120);//ǰ
 173   2        }
C51 COMPILER V9.54   MAIN                                                                  05/10/2021 21:37:16 PAGE 4   

 174   1        else
 175   1        {
 176   2          if(data1 == 10)//Сƫңת
 177   2          {
 178   3            left_run(80,160);//ת
 179   3          }
 180   2          if(data1 == 1)//Сƫת
 181   2          {
 182   3            right_run(160,80);//ת
 183   3          }
 184   2          if(data1 == 0)//ƫƫң
 185   2          {
 186   3            stop(); 
 187   3          }
 188   2        }
 189   1      }
 190          //
 191          void IRavoid()
 192          {
 193   1        //Ϊ0 ûʶ𵽺 Ϊ1ʶ𵽺
 194   1        char data1,data2 = left_led2,data3 = right_led2;
 195   1        data1 = data2*10+data3;
 196   1        if(data1 == 11)//û⵽ϰǰ
 197   1        {
 198   2          forward(120,120);//ǰ
 199   2        }
 200   1        else
 201   1        {
 202   2          if(data1 == 10)//Ҽ⵽ϰת¼Ϊ״̬1
 203   2          {
 204   3            left_run(120,120);//ת
 205   3          }
 206   2          if(data1 == 1)//⵽ϰת¼Ϊ״̬2
 207   2          {
 208   3            right_run(120,120);//ת
 209   3          }
 210   2          if(data1 == 0)//Ҷ⵽ϰ
 211   2          {
 212   3            stop();//ͣ
 213   3            Delay_Ms(100);//ִͣʱ
 214   3            back_run(120,120);//
 215   3            Delay_Ms(200);//ִк˵ʱ
 216   3            right_run(120,120);//תͷ
 217   3            Delay_Ms(280);//ִתʱ        
 218   3          }
 219   2        }
 220   1      }
 221          /*====================================
 222          void Delay_Ms(INT16U ms)
 223          msʱβ
 224          12T 51ƬӦʱӺ뼶ʱ
 225          ====================================*/
 226          void Delay_Ms(unsigned int ms)
 227          {
 228   1           unsigned int i;
 229   1         do{
 230   2              i = MAIN_Fosc / 96000; 
 231   2            while(--i);   //96T per loop
 232   2           }while(--ms);
 233   1      }
 234          //ս
 235          void QXMBOT_IRcordpro()            //ȡ33ݽ
C51 COMPILER V9.54   MAIN                                                                  05/10/2021 21:37:16 PAGE 5   

 236          {
 237   1        unsigned char i, j, k, cord, value; /*iڴ4ֽڣjڴһֽÿһλk33еһ
             -
 238   1        cordȡʱжǷ1ʱ*/
 239   1        k = 1;            //ӵһλʼȡ
 240   1        for(i = 0; i < 4; i++)
 241   1        {
 242   2          for(j = 0; j < 8; j++)
 243   2          {
 244   3            cord = IRdata[k];     //cord
 245   3            if(cord > 5)      //11.0592t0ΪԼ278us*5=1390ôжΪ1
 246   3            value = value | 0x80; /*յʱȽλ
 247   3            λȷŵvalueλں0x08λһ
 248   3            ıvaluaλֵֻλΪ1*/
 249   3            if(j < 7)
 250   3            {
 251   4              value = value >> 1; //valueλν8λݡ
 252   4            }
 253   3            k++;        //ÿִһλ1
 254   3          }
 255   2          IRcord[i] = value;     //ÿһֽڰIRcordС
 256   2          value = 0;         //value´ڴ
 257   2        }
 258   1        IRpro_ok = 1;          //4ֽںIRpro ok1ʾ 
 259   1      }
 260          /*********************************************
 261          QX_A11Сң
 262          ڲ
 263          ڲ: 
 264          ˵
 265          **********************************************/
 266          void QXMBOT_IR_Remote(void)
 267          {
 268   1        if(IRok)    //жǷ                    
 269   1        {   
 270   2          QXMBOT_IRcordpro();//4ֽڵ
 271   2          IRok = 0; //µȴ
 272   2          if(IRpro_ok) //жǷ  
 273   2          {
 274   3                switch(IRcord[2])
 275   3              {
 276   4                 case 0x18:  stop(); Delay_Ms(200); forward(120,120);        //ǰ
 277   4                         break;
 278   4                 case 0x52:  stop(); Delay_Ms(200); back_run(120,120);         //  
 279   4                         break;
 280   4                 case 0x08:  stop(); Delay_Ms(200); left_run(120,120);       //ת
 281   4                         break;
 282   4               case 0x5A:  stop(); Delay_Ms(200); right_run(120,120);        //ת
 283   4                         break;
 284   4               case 0x1C:  stop();           //ֹͣ
 285   4                         break;
 286   4               default:break;
 287   4              }
 288   3            IRpro_ok = 0;
 289   3          }
 290   2        }   
 291   1      }
 292          /********************* Timer0ʼ************************/
 293          void Timer0_Init(void)
 294          {
 295   1        TMOD |= 0x02; //ʱ0ʽ28λԶװ
 296   1        TH0 = 0x00;  //8λװ0ôʱһεʱ256
C51 COMPILER V9.54   MAIN                                                                  05/10/2021 21:37:16 PAGE 6   

 297   1        TL0 = 0x00;
 298   1        ET0 = 1;     //ʱ0ж
 299   1        TR0 = 1;     //ʱ0  
 300   1      }
 301          /********************* Timer0ʼ************************/
 302          void Timer1_Init(void)
 303          {
 304   1        TMOD |= 0x20;//ʱ18λԶװģ
 305   1        TH1 = 164;
 306   1        TL1 = 164;//11.0592M12TʱԼ100΢
 307   1        TR1 = 1;//ʱ1
 308   1        ET1 = 1;//ʱ1ж 
 309   1      }
 310          /********************* ⲿж0ʼ************************/
 311          void EXTI0_Init(void)
 312          {
 313   1        IT0 = 1;     //ⲿж0Ϊشʽһ½شһ
 314   1        EX0 = 1;     //ⲿж0  
 315   1      }
 316          /********************* ⲿж0жϺ************************/
 317          void QXMBOT_int0() interrupt 0        //ⲿж0
 318          {
 319   1        static unsigned char i;       //  ̬ڻִеʱ򲻻ᶪʧֵiڰ33θߵƽ
             -ĳʱIRdata
 320   1        static bit startflag;   //ʼ־λ
 321   1        if(startflag)       //ʼ
 322   1        {
 323   2          if( (IRtime < 53) && (IRtime >= 32) ) /*жǷ룬׵ƽ9000us+4500us 
 324   2          Լ11.0592NECЭ8000-10000+4000-5000 
 325   2          Ѿôiᱻ0ͻῪʼδ*/
 326   2            i = 0;         //ôִi=0浽IRdataĵһλ
 327   2          IRdata[i] = IRtime;      //T0ʱ浽浽ж
 328   2          IRtime = 0;        //㣬һ½صʱڴ
 329   2          i++;           //Ĵ
 330   2          if(i == 33)          //34 ±Ǵ0ʼi33ʾִ34
 331   2          {
 332   3            IRok = 1;        //ôʾ
 333   3            i = 0;         //׼´δ
 334   3          }
 335   2        }
 336   1        else      
 337   1        {
 338   2          IRtime = 0;          //뿪ʼ㿪ʼ
 339   2          startflag = 1;       //ʼ־λ1
 340   2        }
 341   1      }
 342          /********************* Timer0жϺ************************/
 343          void timer0_int (void) interrupt 1
 344          {
 345   1         IRtime++;         //1Ϊ278us
 346   1      }
 347          /********************* Timer0жϺ************************/
 348          void timer1_int (void) interrupt 3
 349          {
 350   1         pwm_val_left++;
 351   1         pwm_val_right++;
 352   1         QXMBOT_LoadPWM();//װPWM
 353   1      } 


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    650    ----
C51 COMPILER V9.54   MAIN                                                                  05/10/2021 21:37:16 PAGE 7   

   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     43       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
